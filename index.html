<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>F1Tenth Pure Pursuit</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
      async
    ></script>
    <script>
      window.MathJax = {
        loader: { load: ["input/asciimath", "output/chtml"] },
        asciimath: {
          delimiters: [["`", "`"]],
        },
      };
    </script>
  </head>
  <body>
    <header>
      <nav>
        <ul>
          <li><a href="#introduction">Introduction</a></li>
          <li><a href="#demonstration">Demonstration</a></li>
          <li><a href="#waypoints-generation">Waypoints Generation</a></li>
          <li><a href="#algorithm">Algorithm</a></li>
        </ul>
      </nav>
    </header>

    <section id="introduction">
      <h2>Introduction of Pure Pursuit</h2>
      <p>
        Pure Pursuit is a map-based racing algorithm used in the F1Tenth
        project. It tracks the waypoints on the map and drives towards the next
        best point.
        <br />Skeleton code and instructions can be found here:
        <a href="https://github.com/unlv-f1/lab7/tree/main"
          >https://github.com/unlv-f1/lab7/tree/main</a
        >.
      </p>

      <p><br />Pure Pursuit utilizes these technologies:</p>
      <ul>
        <li>
          ROS2 (Robot Operating System 2) to interact with the hardware (VESC,
          servo, lidar, etc.)
        </li>
        <li>
          SLAM (Simultaneous Localization and Mapping), which uses lidar to
          generate a map
        </li>
        <li>
          Particle Filter, which uses lidar to estimate the car's location on
          the map
        </li>
      </ul>

      <p><br />We implemented:</p>
      <ul>
        <li>Pure Pursuit algorithm</li>
        <li>Arduino with a joystick to drive around the simulation map</li>
        <li>A logger to log the x and y position on the map</li>
        <li>Interactive marker to display the logged waypoints</li>
      </ul>

      <p>
        <br />This project is a collaboration between
        <a href="">Jason Henry</a> and <a href="">Emily Sudjana</a>. This
        website contains explanations of our algorithm. Code will not be given.
      </p>
    </section>

    <section id="demonstration">
      <h2>Pure Pursuit Demonstration</h2>
      <h3>
        Below are videos of our Pure Pursuit algorithm running on the simulation
        car and the real car.
      </h3>
      <div class="video-image-container">
        <video playsinline autoplay muted loop width="700">
          <source src="./assets/videos/sim_car_demo.mp4" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
        <video playsinline autoplay muted loop width="700">
          <source src="./assets/videos/real_car_demo.mp4" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
      </div>
    </section>

    <section id="waypoints-generation">
      <h2>Waypoints Generation</h2>
      <h3>Here are the steps for our waypoints generation:</h3>
      <ol>
        <li>
          The Arduino reads the joystick signal and sends a packet via the
          serial port. The packet is 6 bytes long, containing the beginning
          signal (1 byte), joystick position (4 bytes int), and joystick button
          (1 byte).
        </li>
        <li>
          rviz_remote.py, a program we created, listens to the serial port for a
          packet, interprets the packet, and publishes speed and steering angle
          for the simulator car. The joystick position is used for steering
          angle, and the joystick button is used for starting/stopping the car.
        </li>
        <li>
          logger.py, another program we created, logs the x, y, z coordinates of
          the car every 1 meter.
        </li>
        <li>
          race_line.cpp, another program we created, displays the logged
          waypoints to the simulation map.
        </li>
      </ol>
      <div class="video-image-container">
        <img
          src="./assets/images/waypoint_logger/logger_data_flow.png"
          alt="Data flow diagram on logging"
          width="800"
        />
      </div>

      <div class="video-image-container">
        <video playsinline autoplay muted loop width="500">
          <source src="./assets/videos/logging.mp4" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
        <img
          src="./assets/images/generated_waypoints.png"
          alt="Displaying generated waypoints on the simulation map"
          width="500"
        />
      </div>
    </section>

    <section id="algorithm">
      <h2>Pure Pursuit Algorithm</h2>

      <h3>High-Level View of Our Algorithm</h3>
      <ol>
        <li>Find the closest waypoint to the car.</li>
        <li>
          Based on the curvature of the track, determine the next furthest
          straight waypoint.
        </li>
        <li>Calculate the steering angle to steer towards the goal point.</li>
        <li>Dynamically calculate the speed based on the steering angle.</li>
        <li>
          Send an Ackermann drive message with the steering angle and speed.
        </li>
      </ol>

      <div class="subsection">
        <h3>How to Calculate Steering Angle</h3>
        <p>
          Firstly, without accounting for orientation, we can calculate the
          angle heading, θ, as follows (Note: we use atan2 because it returns
          angles between -180° to 180°):
        </p>
        <div class="video-image-container">
          <img
            src="./assets/images/steering_angle/angle_diff.png"
            alt="Calculating angle heading angle between 2 points"
            width="300"
          />
        </div>
        <p class="equation">`θ = "atan2"((y_2 - y_1) / (x_2 - x_1))`</p>

        <p>
          Next, since the pose message gives orientation in quaternion with x,
          y, z, w components, we need to convert it to Euler angles using this
          equation:
        </p>
        <p class="equation">
          `"orientation" = "atan2"((2 * (x * y + w * z)) / (w^2 + x^2 - y^2 -
          z^2))`
        </p>

        <p>
          Then, if we take the orientation from the perspective of the car by
          negating it, Φ, we can visualize it as follows:
        </p>
        <p class="equation">`Φ = -"orientation"`</p>
        <div class="video-image-container">
          <img
            src="./assets/images/steering_angle/orientation.png"
            alt="orientation illustration"
            width="300"
          />
        </div>

        <p>Now calculating for steering angle, we account for both Φ and θ:</p>
        <div class="video-image-container">
          <img
            src="./assets/images/steering_angle/steering.png"
            alt="Calculating steering angle"
            width="300"
          />
        </div>
        <p class="equation">`"steering angle" = Φ + θ `</p>

        <p>
          One of the challenges we encounter is that the steering angle becomes
          unreliable near the -180°/180° orientation due to a discontinuity. As
          a result, the steering angle can be off by 360°. To fix this, we take
          the asin(sin(steering_angle)) to map the steering angle back to the
          correct range. So the final equation would be:
        </p>
        <p class="equation">`"steering angle" = "asin"(sin(Φ + θ))`</p>
      </div>

      <div class="subsection">
        <h3>How to Implement Dynamic Lookahead</h3>
        <p>
          To implement dynamic lookahead, we need to consider the curvature of
          the track. The simplest way is to calculate the next angle heading, θ,
          from each point to the next. In this illustration, there are the
          current, previous, and next waypoints. The first slope, m1, is the
          slope of the current and previous waypoints. The slope m2 is the slope
          of the current and next waypoints. Then the angle between two slopes
          can be calculated using the equation below.
        </p>
        <div class="video-image-container">
          <img
            src="./assets/images/dynamic_lookahead/next_heading.png"
            alt="Calculating the next heading on each point"
            width="300"
          />
        </div>
        <p class="equation">`θ = "atan"(abs((m_1 - m_2) / (1 + m_1 * m_2)))`</p>

        <p>
          After calculating the angle heading on every waypoint, we will have
          this data (visualized as a table):
        </p>
        <table border="1">
          <thead>
            <tr>
              <th>index</th>
              <th>x</th>
              <th>y</th>
              <th>next heading</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>-4.74</td>
              <td>3.23</td>
              <td>0.64°</td>
            </tr>
            <tr>
              <td>2</td>
              <td>-4.80</td>
              <td>3.14</td>
              <td>2.11°</td>
            </tr>
            <tr>
              <td>...</td>
              <td>...</td>
              <td>...</td>
              <td>...</td>
            </tr>
          </tbody>
        </table>

        <p>
          Next, we continue looping from the current waypoint to the next until
          the cumulative sum of the next heading is above a certain threshold.
          The last index that it looped on is the furthest waypoint that is
          still straight.
        </p>
      </div>

      <div class="subsection">
        <h3>How to Calculate Speed</h3>
        To calculate speed, we simply use a speed function that depends on the
        steering angle.
        <div class="video-image-container">
          <img
            src="./assets/images/speed_function/speed_function.png"
            alt="Speed function"
            width="500"
          />
        </div>
      </div>
    </section>
  </body>
</html>
